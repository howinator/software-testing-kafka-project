%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
% University Assignment Title Page 
% LaTeX Template
% Version 1.0 (27/12/12)
%
% This template has been downloaded from:
% http://www.LaTeXTemplates.com
%
% Original author:
% WikiBooks (http://en.wikibooks.org/wiki/LaTeX/Title_Creation)
%
% License:
% CC BY-NC-SA 3.0 (http://creativecommons.org/licenses/by-nc-sa/3.0/)
% 
% Instructions for using this template:
% This title page is capable of being compiled as is. This is not useful for 
% including it in another document. To do this, you have two options: 
%
% 1) Copy/paste everything between \begin{document} and \end{document} 
% starting at \begin{titlepage} and paste this into another LaTeX file where you 
% want your title page.
% OR
% 2) Remove everything outside the \begin{titlepage} and \end{titlepage} and 
% move this file to the same directory as the LaTeX file you wish to add it to. 
% Then add \input{./title_page_1.tex} to your LaTeX file where you want your
% title page.
%
% template taken from https://www.overleaf.com/latex/examples/title-page-with-logo/hrskypjpkrpd#.WDXHQKIrLdc
%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
%\title{Title page with logo}
%----------------------------------------------------------------------------------------
%   PACKAGES AND OTHER DOCUMENT CONFIGURATIONS
%----------------------------------------------------------------------------------------

\documentclass[12pt]{article}
%\usepackage[margin=0.1in]{geometry}
\usepackage{multicol}
\usepackage{wrapfig}
\usepackage[english]{babel}
\usepackage[utf8x]{inputenc}
\usepackage{algpseudocode}
\usepackage{algorithm}
\usepackage{algorithmicx}
\usepackage{amsmath}
\usepackage{courier}
\usepackage{graphicx}
\usepackage{hyperref}
\usepackage{listings}
\usepackage{caption}
\usepackage{url}
\usepackage[colorinlistoftodos]{todonotes}
	\addtolength{\oddsidemargin}{-.875in}
	\addtolength{\evensidemargin}{-.875in}
	\addtolength{\textwidth}{1.75in}

\newcommand\myfigure[6]{%
  \ifdim#2>.8\linewidth
    {%
      \centering
      \includegraphics[width=#3]{#4}%
      \captionof{figure}{#5}%
    }%
  \else
  \begin{wrapfigure}{#1}{#2}
    \includegraphics[width=#3]{#4}
    \caption{#5}
    \label{#6}
  \end{wrapfigure}
  \fi
}

\begin{document}

\begin{titlepage}

\newcommand{\HRule}{\rule{\linewidth}{0.5mm}} % Defines a new command for the horizontal lines, change thickness here

\center % Center everything on the page
 
%----------------------------------------------------------------------------------------
%   HEADING SECTIONS
%----------------------------------------------------------------------------------------

\textsc{\LARGE The University of Texas at Austin}\\[1.5cm] % Name of your university/college
\textsc{\Large Software Testing}\\[0.5cm] % Major heading such as course name
\textsc{\large Software Engineering - Option III}\\[0.5cm] % Minor heading such as course title

%----------------------------------------------------------------------------------------
%   TITLE SECTION
%----------------------------------------------------------------------------------------

\HRule \\[0.4cm]
{ \huge \bfseries Testing Distributed Systems - Kafka}\\[0.4cm] % Title of your document
\HRule \\[1.5cm]
 
%----------------------------------------------------------------------------------------
%   AUTHOR SECTION
%----------------------------------------------------------------------------------------

\begin{minipage}{0.4\textwidth}
\begin{flushleft} \large
\emph{Authors:}\\
Howie \textsc{Benefiel}\\
Dale \textsc{Pedinski} % Your name
\end{flushleft}
\end{minipage}
~
\begin{minipage}{0.4\textwidth}
\begin{flushright} \large
\emph{Professor:} \\
Dr. Sarfraz \textsc{Khurshid} % Supervisor's Name
\end{flushright}
\end{minipage}\\[2cm]

% If you don't want a supervisor, uncomment the two lines below and remove the section above
%\Large \emph{Author:}\\
%John \textsc{Smith}\\[3cm] % Your name

%----------------------------------------------------------------------------------------
%   DATE SECTION
%----------------------------------------------------------------------------------------

{\large \today}\\[2cm] % Date, change the \today to a set date if you want to be precise

%----------------------------------------------------------------------------------------
%   LOGO SECTION
%----------------------------------------------------------------------------------------

\includegraphics{logo.png}\\[1cm] % Include a department/university logo - this will require the graphicx package
 
%----------------------------------------------------------------------------------------

\vfill % Fill the rest of the page with whitespace

\end{titlepage}

\begin{multicols}{2}
\setlength{\columnsep}{1cm}

\begin{abstract}
\end{abstract}


\section{Prior Work}

From our literature review, we found that the field of testing distributed systems is relatively unexplored.
This is backed up by the findings of Yuan et al. \cite{simpletesting}.

\subsection{Simple Testing Can Prevent Most Critical Failures}

The authors of Yuan et al. analyzed a number of open-source distributed systems running production workloads in industry currently.
Their findings showed that a large percentage of catastrophic failures could have been prevented by simple tests and static analysis.

In Yuan et al.'s paper, they studied the catastrophic failures 5 distributed, data-intensive systems, Cassandra, HBase, Hadoop Distributed File System (HDFS), Hadoop MapReduce, and Redis.
They defined a catastrophic failure as a failure which would result in unavailability of the system or data loss.
To determine the faults of the system, the authors analyzed failures reported on the respective system's bug tracker.
For each system, the authors analyzed the catastrophic failures.

In general, Yuan et al. found that the failure modes of distributed systems were complex.
The authors determined that the complexity of these failure modes was caused by the relatively large state space of distributed systems.
Quantitatively, they found that 77\% of failures required more than one event to produce the failure, and 90\% required no more than three.

The authors of Yuan et al. then analyzed the types of inputs required to produce the failure.
The most unexpected finding from this analysis is that 24\% of failures were caused by a node becoming unreachable.
This is surprising because a core tenant of distributed systems is fault-tolerance, i.e., the system should be able to handle node\(s\) becoming unavailable.

The authors also analyzed the determinism of failures.
In distributed systems, there is the possibility that a sequence of events could produce a failure sometimes while not producing a failure other times.
The authors found that 74\% of failures are deterministic.
This is a promising result because it means the failures are not by determined by the timing of the input events.

By far the most unexpected result of this paper was that 92\% of errors in distributed systems are caused by incorrect handling of errors.
Put another way, the system identified a fault could occur, but then the system handled it incorrectly.
Further breaking down catastrophic failures, the authors found that 35\% of catastrophic failures were caused by trivial mistakes, e.g., a "TODO" in the error handler or an ignored error.

To rectify these errors, the authors built a static checker, Aspirator, which checks a codebase for trivially incorrect error handling.
We were not able to install Aspirator ourselves because the binaries are no longer hosted, but we did replicate some of Aspirator's functionality with simple searches.
We found that in Kafka, there is at least one error handler with a "TODO" which would have caused Aspirator to fail.

\subsection{Confluent Testing Effort for Kafka}

A major vendor of Kafka, Confluent, has invested heavily in testing Kafka which they have documented \cite{confluenttesting}.
The Kafka testing process begins when any change is proposed.
When a feature is proposed, the feature\'s design is described by a design document called a Kafka Improvement Proposal \(KIP\).

\vspace{1em}
\myfigure{L}{\linewidth}{\linewidth}{./kafkatestreport.png}{Sample of Kafka test report}{fig:kafkareport}
\vspace{1em}
Once the KIP is accepted, the feature is then built.
The built feature then goes through a thorough code review process where core developers examine the patch line-by-line.

In terms of actual testing, the Kafka project uses three kinds of tests: unit tests, integration tests and distributed systems tests.
Kafka has at least 6,800 unit tests and 600 integration tests in the code base.
There is no mention of their code coverage.

The third type of test mentioned by Confluent, distributed systems tests, are relatively novel.
These types of tests involve putting the whole system under load and then injecting faults.
Kafka has 310 of these type of tests which they run nightly.
They then test the results of these tests online nightly.
A sample from a recent test report is shown in \ref{fig:kafkareport}.
These distributed tests are the reason that Confluent built Duck Tape which is discussed in detail above.


\section{Evaluation}

We showed that testing distributed systems can be challenging and the tooling for in the field is not great.
Our first approach, using Duck Tape, did not work at all for two reasons.

First, Duck Tape does not work for our preferred version of python.
This is indicative of a project which is not well-maintained.

Second, the Duck Tape framework only worked for positive test cases.
If there was a test case which failed, Duck Tape would crash.

In terms of our own custom testing framework, we found that our framework worked well for simple test cases.
We were able to successfully test that messages were posted to Kafka brokers.
Further, we were able to produce a node failure in the cluster mid-test which proved Kafka's failover ability.
Proving that these simple, but essential functions worked was an honest success for this project.

In terms of areas for improvement, there are a three things we would like to explore.

First, we would like to test the system under load.
This would involve saturating the connection to the brokers with messages.
Once the system is under load, we would like to inject faults by stopping nodes.

Second, we would like to simulate network failures.
In our tests, we were only able to inject faults via node failure.
If we had control over the network that the cluster was running on, we could randomly drop packets and observe how the system reacted.

Third, we would like to automate this testing infrastructure by creating a fresh cluster for each test case.
Configuration and state could be inherited from test-to-test, so by creating a new cluster for each test, via Jenkins and Kubernetes, we could isolate failures for proper debugging.

\section{Conclusion}

In all, we have explored the area of testing in distributed systems.
By investigating the testing options available to one of the largest open-source distributed systems project, Kafka, we were able to find that the field of testing in distributed systems is relatively unexplored.

We started with the primary testing framework available for Kafka, Duck Tape.
After attempting to use the framework, we found that it is not ready to ready for widespread use.

We developed our own testing framework which performed well for a limited set of simple test cases.
However our testing framework is not well-suited for complex tests which would present as faults in a distibuted system.

\section{Duck Tape}

\section{Custom Testing Apparatus}


\end{multicols}
\newpage


\bibliographystyle{plain}
\bibliography{references.bib}



\appendix

\section{Github Code}

\href{https://github.com/howinator/software-testing-kafka-project}{https://github.com/howinator/software-testing-kafka-project}

%\section{Thread-Local Example}
%\label{sec:tls}
%\lstinputlisting[language=Java, firstline=366, lastline=382]{../../java-bag/src/SwedishBag.java}
% \section{Some \LaTeX{} Examples}
% \label{sec:examples}

% \subsection{Sections}

% Use section and subse{}ction commands to organize your document. \LaTeX{} handles all the formatting and numbering automatically. Use ref and label commands for cross-references.

% \subsection{Comments}

% Comments can be added to the margins of the document using the \todo{Here's a comment in the margin!} todo command, as shown in the example on the right. You can also add inline comments too:

% \todo[inline, color=green!40]{This is an inline comment.}

% \subsection{Tables and Figures}

% Use the table and tabular commands for basic tables --- see Table~\ref{tab:widgets}, for example. You can upload a figure (JPEG, PNG or PDF) using the files menu. To include it in your document, use the includegraphics command as in the code for Figure~\ref{fig:frog} below.

% % Commands to include a figure:
% \begin{figure}
% \centering
% \includegraphics[width=0.5\textwidth]{frog.jpg}
% \caption{\label{fig:frog}This is a figure caption.}
% \end{figure}

% \begin{table}
% \centering
% \begin{tabular}{l|r}
% Item & Quantity \\\hline
% Widgets & 42 \\
% Gadgets & 13
% \end{tabular}
% \caption{\label{tab:widgets}An example table.}
% \end{table}

% \subsection{Mathematics}

% \LaTeX{} is great at typesetting mathematics. Let $X_1, X_2, \ldots, X_n$ be a sequence of independent and identically distributed random variables with $\text{E}[X_i] = \mu$ and $\text{Var}[X_i] = \sigma^2 < \infty$, and let
% $$S_n = \frac{X_1 + X_2 + \cdots + X_n}{n}
%       = \frac{1}{n}\sum_{i}^{n} X_i$$
% denote their mean. Then as $n$ approaches infinity, the random variables $\sqrt{n}(S_n - \mu)$ converge in distribution to a normal $\mathcal{N}(0, \sigma^2)$.

% \subsection{Lists}

% You can make lists with automatic numbering \dots

% \begin{enumerate}
% \item Like this,
% \item and like this.
% \end{enumerate}
% \dots or bullet points \dots
% \begin{itemize}
% \item Like this,
% \item and like this.
% \end{itemize}

% We hope you find write\LaTeX\ useful, and please let us know if you have any feedback using the help menu above.



\end{document}
